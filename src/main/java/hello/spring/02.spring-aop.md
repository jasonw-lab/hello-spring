---
title:  Spring AOP
createTime: 2019/05/11 13:59:38
permalink: /java/spring/spring-aop/
article: true
#sidebar: false
---

# Spring AOP概要

## Spring AOPとは

Spring AOPは、Springフレームワークの重要な機能の一つで、アスペクト指向プログラミング（Aspect-Oriented Programming）を実現するためのモジュールです。AOPは、横断的関心事（クロスカッティングコンサーン）をモジュール化し、コードの重複を減らし、保守性を向上させるプログラミングパラダイムです。

Spring AOPを使用することで、ログ記録、トランザクション管理、セキュリティ、キャッシュなどの機能を、ビジネスロジックから分離して実装することができます。これにより、コードの再利用性が高まり、開発効率が向上します。

## 主なコンセプト(Key Concepts in Spring AOP)

### Aspect（アスペクト）

アスペクトは、横断的関心事をモジュール化したものです。例えば、ログ記録やトランザクション管理などの機能を一つのモジュールとしてまとめたものがアスペクトです。Spring AOPでは、通常のクラスに特定のアノテーション（`@Aspect`）を付けることでアスペクトを定義します。

```java
@Aspect
@Component
public class LoggingAspect {
    // アスペクトの実装
}
```

### Advice（アドバイス）

アドバイスは、特定のジョインポイントで実行されるアクションです。Spring AOPでは、以下の種類のアドバイスがあります：

1. **Before Advice**：ジョインポイントの前に実行されるアドバイス
2. **After Returning Advice**：ジョインポイントが正常に完了した後に実行されるアドバイス
3. **After Throwing Advice**：ジョインポイントが例外をスローした場合に実行されるアドバイス
4. **After (finally) Advice**：ジョインポイントの実行結果に関わらず、実行後に実行されるアドバイス
5. **Around Advice**：ジョインポイントの前後に実行されるアドバイス。ジョインポイントの実行を制御できます

```java
@Before("execution(* hello.spring.service.*.*(..))")
public void beforeMethodExecution(JoinPoint joinPoint) {
    // メソッド実行前のロジック
}
```

### Join Point（ジョインポイント）

ジョインポイントは、アスペクトが適用される可能性のあるプログラム実行のポイントです。Spring AOPでは、ジョインポイントは常にメソッドの実行を表します。例えば、特定のメソッドが呼び出されたとき、例外がスローされたときなどがジョインポイントになります。

### Pointcut（ポイントカット）

ポイントカットは、どのジョインポイントにアドバイスを適用するかを指定する式です。Spring AOPでは、ポイントカット式を使用して、特定のメソッドやクラスを指定します。

```java
@Pointcut("execution(* hello.spring.service.*.*(..))")
public void serviceLayer() {}
```

### Weaving（ウィービング）

ウィービングは、アスペクトをターゲットオブジェクトに適用し、アドバイス付きのオブジェクトを作成するプロセスです。Spring AOPでは、実行時にプロキシを使用してウィービングを行います。これにより、元のコードを変更することなく、アスペクトを適用することができます。

# サンプルコード

以下は、Spring AOPを使用したメソッド呼び出しのログ記録の例です：

## MethodCallLoggingAspect.java

```java
package hello.spring.aop;

import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.*;
import org.springframework.stereotype.Component;

import java.util.Arrays;

/**
 * メソッド呼び出しをログに記録するためのアスペクト
 * このクラスはSpring AOPを使用して、Serviceクラスのメソッド呼び出しを監視し、
 * 実行前、実行後、例外発生時などにログを記録します。
 */
@Aspect
@Component
public class MethodCallLoggingAspect {

    /**
     * メソッド実行前のアドバイス
     * Serviceクラスのメソッドが実行される前にログを記録します
     * @param jp 実行されるメソッドの情報を含むJoinPoint
     */
    @Before("execution(* *..*Service.*(..))")
    public void beforeLog(JoinPoint jp) {
        System.out.println("[Before]====================================");
        System.out.println("[Before]args:" + Arrays.toString(jp.getArgs()));
        System.out.println("[Before]signature:" + jp.getSignature());
    }

    /**
     * メソッド正常終了後のアドバイス
     * Serviceクラスのメソッドが正常に終了した後にログを記録します
     * @param jp 実行されたメソッドの情報を含むJoinPoint
     * @param randomValue メソッドの戻り値（int型）
     */
    @AfterReturning(value = "execution(* *..*Service.*(..))", returning = "randomValue")
    public void afterReturningLog(JoinPoint jp, int randomValue) {
        System.out.println("[AfterReturn]====================================");
        System.out.println("[AfterReturn]args:" + Arrays.toString(jp.getArgs()));
        System.out.println("[AfterReturn]signature:" + jp.getSignature());
        System.out.println("[AfterReturn]return:" + randomValue);
    }

    /**
     * メソッド例外発生時のアドバイス
     * Serviceクラスのメソッドが例外をスローした場合にログを記録します
     * @param jp 実行されたメソッドの情報を含むJoinPoint
     * @param e スローされた例外（NullPointerException型）
     */
    @AfterThrowing(value = "execution(* *..*Service.*(..))", throwing = "e")
    public void afterThrowingLog(JoinPoint jp, NullPointerException e) {
        System.out.println("[AfterThrowing]====================================");
        System.out.println("[AfterThrowing]args:" + Arrays.toString(jp.getArgs()));
        System.out.println("[AfterThrowing]signature:" + jp.getSignature());
    }

    /**
     * メソッド実行後のアドバイス（finally）
     * Serviceクラスのメソッドの実行結果に関わらず、実行後にログを記録します
     * @param jp 実行されたメソッドの情報を含むJoinPoint
     */
    @After("execution(* *..*Service.*(..))")
    public void afterLog(JoinPoint jp) {
        System.out.println("[After]====================================");
        System.out.println("[After]args:" + Arrays.toString(jp.getArgs()));
        System.out.println("[After]signature:" + jp.getSignature());
    }

    /**
     * メソッド実行の前後を制御するアドバイス
     * getRandomValueで始まるServiceクラスのメソッドの実行を制御し、ログを記録します
     * @param jp 実行されるメソッドの情報を含むProceedingJoinPoint
     * @return メソッドの実行結果
     */
    @Around("execution(* *..*Service.getRandomValue*(..))")
    public Object aroundLog(ProceedingJoinPoint jp) {
        System.out.println("[Around]====================================");
        Object result = null;
        try {
            // 対象メソッド実行
            result = jp.proceed();
            System.out.println("[Around]args:" + Arrays.toString(jp.getArgs()));
            System.out.println("[Around]signature:" + jp.getSignature());
            System.out.println("[Around]return:" + result);
        } catch (Throwable throwable) {
            throwable.printStackTrace();
        }
        return result;
    }
}
```

## SampleService.java

```java
package hello.spring.aop.service;

import org.springframework.stereotype.Service;

import java.util.Random;

/**
 * サンプルサービスクラス
 * このクラスはAOPの動作を確認するためのサンプルメソッドを提供します
 */
@Service
public class SampleService {

    /**
     * 指定されたシード値に基づいてランダムな値を生成するメソッド
     * このメソッドはAOPのアドバイスによってログが記録されます
     * @param seed 乱数生成のためのシード値
     * @return 生成されたランダムな整数値
     */
    public int getRandomValue(int seed) {
        Random random = new Random(seed);
        return random.nextInt();
    }

    /**
     * 文字列の長さを取得するメソッド
     * このメソッドはAOPのアドバイスによってログが記録されます
     * @param str 長さを取得する文字列
     * @return 文字列の長さ
     * @throws NullPointerException 文字列がnullの場合にスローされる例外
     */
    public int getLength(String str) {
        return str.length();
    }
}
```

## AOPのテスト例

```java
package hello.spring.aop;

import hello.spring.aop.service.SampleService;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.TestPropertySource;

/**
 * AOPの動作をテストするためのテストクラス
 * このクラスはSpring AOPの機能が正しく動作することを確認します
 */
@Slf4j
@SpringBootTest
@TestPropertySource(properties = {
    "spring.autoconfigure.exclude=org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration"
})
public class TestAop {

    /**
     * テスト対象のサービスクラス
     * Spring Bootによって自動的に注入されます
     */
    @Autowired
    private SampleService sampleService;

    /**
     * SampleServiceのgetRandomValueメソッドをテストするメソッド
     * このテストを実行すると、AOPによって各種アドバイスが適用され、
     * コンソールにログが出力されます
     */
    @Test
    public void testSample() {
        // このメソッド呼び出しは、AOPによってログが記録されます
        sampleService.getRandomValue(100);
    }

    /**
     * 別のテストメソッド
     * 必要に応じて追加のテストを実装できます
     */
    @Test
    public void test1() throws Exception {
        String password = "123";
        // ここに追加のテストコードを記述できます
    }
}
```

このサンプルコードでは、`MethodCallLoggingAspect`クラスがアスペクトとして定義されており、Serviceクラスのメソッド呼び出しをログに記録します。`@Before`、`@AfterReturning`、`@AfterThrowing`、`@After`、`@Around`などのアドバイスを使用して、メソッドの実行前、正常終了後、例外発生時、実行後、および実行の前後にログを記録しています。

テストクラス`TestAop`を実行すると、`SampleService`の`getRandomValue`メソッドが呼び出され、AOPによって各種アドバイスが適用されます。これにより、コンソールに以下のようなログが出力されます：

```
[Before]====================================
[Before]args:[100]
[Before]signature:int hello.spring.aop.service.SampleService.getRandomValue(int)
[Around]====================================
[After]====================================
[After]args:[100]
[After]signature:int hello.spring.aop.service.SampleService.getRandomValue(int)
[Around]args:[100]
[Around]signature:int hello.spring.aop.service.SampleService.getRandomValue(int)
[Around]return:-1243757041
[AfterReturn]====================================
[AfterReturn]args:[100]
[AfterReturn]signature:int hello.spring.aop.service.SampleService.getRandomValue(int)
[AfterReturn]return:-1243757041
```

このログから、各アドバイスが期待通りに実行されていることが確認できます。

## Spring AOPの設定方法

Spring AOPを使用するには、以下の設定が必要です：

1. 依存関係の追加（Maven pom.xml）：

```xml
<dependencies>
    <!-- Spring AOP -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-aop</artifactId>
    </dependency>
</dependencies>
```
## Sample Code
[download Spring Aop sample code](https://github.com/jasonw-lab/hello-spring)
- src/test/java/hello/spring/aop/TestAop.javaを実行

## Reference
- [Spring AOPリファレンス](https://spring.pleiades.io/spring-framework/reference/core/aop/introduction-defn.html)
- [Spring Boot AOP入門](https://spring.io/guides/gs/aspect-oriented-programming/)
- [AspectJ Documentation](https://www.eclipse.org/aspectj/doc/released/progguide/index.html)
